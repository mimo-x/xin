目 录
版权信息
内容简介
作者简介
序一
序二
序三
序四
前言
致谢
第 1 章 汇编基础
1.1 x86通用寄存器

1.2 常用汇编指令

1.3 内存分页机制

1.4 汇编代码风格

1.5 本章小结

第 2 章 指针

2.1 指针构成

2.2 相关操作

2.3 unsafe包

2.4 本章小结

第 3 章 函数

3.1 栈帧

3.2 逃逸分析

3.3 Function Value

3.4 defer

3.5 panic

3.6 本章小结

第 4 章 方法

4.1 接收者类型

4.2 Method Value

4.3 组合式继承

4.4 本章小结
第 5 章 接口
5.1 空接口
5.2 非空接口
5.3 类型断言
5.4 反射
5.5 本章小结
第 6 章 goroutine

6.1 进程、线程与协程

6.2 IO多路复用

6.3 巧妙结合

6.4 GMP模型

6.5 GMP主要数据结构

6.6 调度器初始化

6.7 G的创建与退出

6.8 调度循环

6.9 抢占式调度

6.10 timer

6.11 netpoller

6.12 监控线程

6.13 本章小结

第 7 章 同步

7.1 Happens Before

7.2 内存乱序

7.3 常见的锁

7.4 Go语言的同步

7.5 本章小结

第 8 章 堆

8.1 内存分配

8.2 垃圾回收

8.3 本章小结

第 9 章 栈

9.1 栈分配

9.2 栈增长
9.3 栈收缩
9.4 栈释放
9.5 本章小结
资源链接
版权信息
书名：深度探索Go语言：对象模型与runtime的原理、特性及应用
编著：封幼林
出版社：清华大学出版社
出版时间：2022-08-
ISBN： 9787302600855

·

内容简介
本书主要讲解Go语言的一些关键特性的实现原理。Nicklaus Wirth大师曾经说过：算法+数据结构＝
程序，语言特性的实现不外乎是数据结构+代码逻辑。

全书内容共分为 4 部分：第一部分是基础特性（第 1 ～ 3 章），第二部分是对象模型（第 4 和 5 章），
第三部分是调度系统（第 6 和 7 章），第四部分是内存管理（第 8 和 9 章）。书中主要内容包括指针、
函数栈帧、调用约定、变量逃逸、Function Value、闭包、defer、panic、方法、Method Value、组
合式继承、接口、类型断言、反射、goroutine、抢占式调度、同步、堆和栈的管理，以及GC等。

书中包含大量的探索示例和源码分析，读者在学会应用的同时还能了解实现原理。书中绝大部分代
码是用Go语言实现的，还有少部分代码是用汇编语言实现的，这些代码都可以使用Go语言官方
SDK直接编译。探索过程循序渐进、条理清晰，用到的工具也都是SDK自带的，方便读者亲自上手
实践。

本书适合Go语言的初学者，在学习语言特性的同时了解其实现原理。更适合有一定的Go语言应用
基础，想要深入研究底层原理的技术人员，以及有一些其他编程语言基础，想要转学Go语言的开
发者阅读。

作者简介
封幼林 资深软件工程师，十多年IT从业经验，曾涉足Win32桌面程序开发、Android移动端开发，
以及互联网服务器端开发等多个领域。喜欢研究底层技术，用自己的方法探究背后的实现原理。热
爰技术交流与分享，创建了微信公众号“幼麟实验室”，致力做一些形象、通透的计算机教程，让开
发者“知其然亦知其所以然”。

序一
FOREWORD
<xin-note>
**常有同学问我，学习技术的原理、机制到底有什么用？现在已经有很多不同的操作系统和编程语
言，我们个人不太可能再去实现操作系统或编程语言！的确如此，如果以学习为目的，我们可以实
现操作系统或编程语言的简陋原型，但在工作中并没有这样的需求和机会，而学习原理、机制的目
的是增进自己对技术问题的判断，同时获得对典型问题和最佳方案的积累，让自己具备分析复杂技
术问题和求解正确的技术方案的能力。
对于编程语言，优秀的程序员既能熟练地使用语言的各种特性，快速满足业务领域开发，又可以掌
握语言的设计原理和底层机制。既是别人眼中的快刀手，也是面对难题，一击必中的高手。工作中
在面对不同技术方案时，可以快速做出最合理的选择。既可以解决当前的问题，又可以让系统长治
久安地演进，将来不会推倒重来，而这些分析判断都取决于你对技术原理和机制的理解。
最近几年，Go语言进展迅速，吸引广大的程序员学习和使用。Go语言有很多优秀特性，如
goroutine可以让大家轻易写出高并发的服务。语言掌握起来也简单，往往学习两三周，就可以实际
投入工作开发，但真正遇到复杂的场景、资源竞争或GC敏感时，缺少对Go语言机制和进程结构的
理解，你会很难完成上述挑战。很可能当你使用Go语言多年后，仍然不能写出健壮的核心业务服
务。**
</xin-note>

在《深度探索Go语言——对象模型与runtime的原理、特性及应用》中，封幼林把Go语言主要的核
心特性从原理到应用，从底层的汇编代码到Go语言代码，以庖丁解牛般的剖析让读者对Go语言豁
然开朗，使语言的原理与机制变得清晰和简单。相信读者在认真学习后，将使自己对Go语言理解
与掌握有一个质的飞跃。

左文建
奇安信集团副总裁

序二
FOREWORD
Go语言诞生距今已有十余年，我最开始使用Go语言还是在 2012 年，当时Go语言的1.0版本刚刚发
布，虽然继承了Plan 9的衣钵，却有很多让人诟病的地方。我们当时用Go语言实现了一些HTTP
Client和网络爬虫业务，虽然编写过程十分顺畅，但是会遇到goroutine和GC的性能和其他稳定性的
问题，于是就变成了一次浅尝辄止的尝试。

随着时间的推移，我再次在业务中使用的Go语言已经到了1.4版本，它的稳定性问题已得到了解
决。很快，随着Go 1.5版本的发布，GC性能问题也不复存在，Go语言终于成长为一门优秀的开发
语言。而随着最近几次版本的新特性——泛型的加入，Go语言在表达能力上获得更进一步的提
升，未来十分可期。

我大部分时间在用Go语言写服务器端程序，但也用Go语言写过客户端程序，写过PoC，写过
DSL，写过JIT，甚至写过嵌入式程序的通信界面，Go语言现在对我来讲已经成为相当称手的工
具。选择Go语言进行开发意味着快速、便捷、高性能，甚至它已经成为云原生的代名词。

在我最初接触Go语言的时候，当时唯一一本Go语言的书籍就是许式伟老师编写的《Go语言编
程》，可以说是大家用中文学习Go语言的唯一途径，而现在则不断有很棒的中文书籍问世。《深
度探索Go语言——对象模型与runtime的原理、特性及应用》直接从底层开始，为大家介绍需要的
汇编基础知识，紧接着从指针、函数、goroutine逐步深入，不断剖析Go语言原理，让大家获得最
贴近实现原理的知识。拨开运行时的迷雾，不必猜测编写的Go语言代码运行时的行为，真正地让
大家掌握Go语言全部的精髓。可以毫不夸张地说，这是一本Go语言的High-End图书。

书中作者先用示例代码描述原理和概念，然后辅以图例说明，最后使用对应生成的汇编代码予以佐
证，可以说是学习Go语言底层知识的最佳途径。我阅读Go语言源代码特别喜欢直接在Go语言源码
中进行Hack，得益于Go语言的编译速度，Hack完毕后进行编译，然后测试修改结果也十分迅速，
这无疑提升了学习速度。建议大家不要怕源代码，只有在源代码中才能洞悉设计者的真正意图，才
能理解设计所面临的工程问题和解决方案的精妙之处。

相信大家看完本书后，一定会受益匪浅，水平得到质的提升！

张旭红
金山办公Exline技术副总监，掘金技术社区前技术总监

序三
FOREWORD
不知从什么时候起，Go语言圈子里突然多了一个看上去很可爱的蛋壳形象，把Go语言的底层实现
与枯燥的runtime知识变成了妙趣横生的动画，呈现在编程世界里，赢得了大家的喜爱，让人有一
种“旧时王谢堂前燕，飞入寻常Gopher家”的感觉。

一件事情，一门技术，如果能让大多数人觉得有意思，那再去学习它就不是什么难事了。

作者输出的文章和动画让我对作者本身也产生了一些兴趣，因为我也是一个Gopher和技术写作者，
深知把庞杂的底层知识给别人讲明白是一件多么有挑战的事情。这些透彻的文章，以及看了令人舒
心的技术动画，到底是怎么制作出来的呢？

在微信上与作者做过简单的交流之后，得知了作者自身多年的开发经验，以及底层与C++的研发背
景，这些谜团便揭开了。在我的研发生涯中碰到的大多数C/C++工程师，对于底层和高并发知识都
能如数家珍，但能够将这些积累与他人说清道明并不是每个人都能做得到的。既能学会又能讲清之
人少之又少，作者就是其中之一，会使用VideoScribe的工程师也不是那么多。

现代的软件工程师，无论是应用工程师，还是基础设施工程师，都会对底层、高并发知识有浓厚的
兴趣，这不是没有理由的，因为这些知识能够帮助我们定位出大部分日常开发中碰到的性能问题，
理解并解决所有线上遇到的高并发环境下才会触发的Bug。这些知识也是每个有追求的互联网公司
的工程师所必备的专业素质，多读书，多写代码，多积累，最终才能让我们一步一步成为一个合格
的技术专家，这些与公司内的头衔无关，是真正的技术硬实力。

本书的内容主要是Go语言的底层知识，相比其他写底层的书而言可能没有覆盖到“所有”底层细
节，但其覆盖到的内容都是细之又细，相信大家在阅读本书或阅览作者制作的Go语言系列动画时
一定能够有所收获。

曹春晖
《Go语言高级编程》作者

序四
FOREWORD
得知《深度探索Go语言——对象模型与runtime的原理、特性及应用》即将出版上市，我感到非常
高兴，更开心的是作者邀请我为此书写推荐序。

我和封幼林的相识，是通过幼麟实验室。幼麟实验室从 2020 年 5 月开始，持续以图解的形式讲解计
算机和Go语言的相关知识，至今已经发布了一系列与Go语言相关的视频。内容涉及Go语言的
slice、map、内存对齐、函数栈帧、闭包、defer和panic等基础特性，还有反射、goroutine、调度系
统、Mutex、channel，以及GC等复杂问题，都以简单易懂的形式呈现出来。对广大Gopher来讲，
是非常不错的参考学习资料。

本书是作者在图解视频和知乎系列文章的基础上，更加系统地重新创作而成。我们从本书的副标
题“对象模型与runtime的原理、特性及应用”，就能看出本书的侧重点，对于想要深入了解这部分内
容的读者很有参考价值。

本书从反汇编开始，结合图示讲解和源码分析，非常系统地探索了Go语言的基础特性、对象模
型、调度系统和内存管理模块。在讲解Go语言底层知识的同时，作者的探索方法也很值得学习借
鉴，让我们知其然也知其所以然。特别是对想要亲自动手探索语言底层实现的读者来讲，简直就是
福音。

杨文
Go夜读发起人

前言
PREFACE
近几年来，Go语言作为一门服务器端开发语言越来越受欢迎，简洁易学的语法加上天生的高并发
支持，还有日益完善的社区，让很多互联网公司开始转向Go语言。随着Go语言生态日趋成熟，各
种组件框架如雨后春笋般涌现，市面上相关的书籍也多了起来，但是其中大部分是以应用为主，对
于语言特性本身探索一般不太深入。笔者希望能够有一本讲解语言特性及实现原理的书，这也是写
作本书的动机。

笔者当年刚参加工作的时候，使用的第一门开发语言是C++。虽然之前在学校用过C语言和汇编语
言，但在接触到C++的一些面向对象特性时还是困惑了很久。直到有一天发现了《深度探索C++对
象模型》，作者Stanley Lippman当年在贝尔实验室工作，是世界上第 1 个C++编译器——cfront的实
现者，他从一个语言实现者的高度，对一些关键特性的实现原理及其背后的思考进行了详细阐述，
使笔者受益匪浅。后来因为工作的原因，笔者开始使用Go语言，因为有了C/C++相关的基础，所以
学习起来更加高效。尤其是当年学习C++对象模型，让笔者认识到语言特性也是通过数据结构和代
码实现的，所以就按照自己的方式一边学习一边探索。第一次萌生要写点东西的念头是在给从PHP
转Go语言的妻子讲完接口动态派发的实现原理后，用她的话来讲就是有种豁然开朗的感觉，并鼓
励笔者把这些东西整理一下。后来我们就在微信公众号上以幼麟实验室的名义发布了一系列视频和
文章，主要分析语言特性的底层实现。在一年多的时间里，幼麟实验室受到了广大网友的好评与支
持，清华大学出版社的赵佳霓编辑也是在此期间联系了笔者，希望笔者能够把自己的探索研究整理
成书。因为写作本书的关系，让笔者能够更系统地思考，收获颇多。希望本书能够帮助各位读者，
解决大家学习Go语言中遇到的一些困惑。

本书主要内容

第 1 章介绍x86汇编的一些基础知识，包括通用寄存器、几条常用的指令，以及内存分页的实现原理
等。

第 2 章介绍指针的实现原理，包括指针构成、相关操作，以及Go语言的unsafe包等。

第 3 章围绕函数进行一系列探索，包括栈帧布局、调用约定、变量逃逸、Function Value、闭包、
defer和panic等。

第 4 章介绍方法的实现原理，包括接收者类型、Method Value和组合式继承等。

第 5 章围绕接口对Go语言的动态特性展开探索，包括装箱、方法集、动态派发、类型断言、类型系
统和反射等。

第 6 章介绍goroutine的实现，包括GMP模型、goroutine的创建与退出、调度循环、抢占式调度、
timer、netpoller和监控线程等。

第 7 章介绍同步的原理及其相关的组件，包括内存乱序、原子指令、自旋锁、Go语言runtime中的互
斥锁和信号量，以及sync.Mutex和channel等。

第 8 章介绍堆内存管理，包括heapArena、mspan等几种主要的数据结构，mallocgc函数的主要逻
辑，以及GC的三色抽象、写屏障等。

第 9 章介绍栈内存管理，包括goroutine栈的分配、增长、收缩和释放等。

阅读建议

本书写作过程主要使用了Go 1.16及之前的几个版本，为了避免后续版本可能发生的不兼容问题，
相关示例建议使用Go 1.13～Go 1.16编译运行。

阅读本书不需要精通汇编语言、操作系统，但是需要对进程、线程这类基本概念有所了解。毕竟
Go语言可直接构建生成系统原生的可执行文件，如果想要深入理解一些语言特性的实现原理，还

是建议学习并实践一下多线程编程、IO多路复用这类关键技术。
第一部分主要包括指针和函数，笔者希望大家能够通过这部分内容，对运行时栈及函数栈帧的相对
寻址方式有深入的理解，为后续探索打下坚实的基础。
第二部分想要表达对Lippman大师的崇高敬意，至今难忘初次阅读《深度探索C++对象模型》时那
种“初闻大道，喜不自胜”的心情。按照Lippman大师的解释，对象模型应该是编译器对自定义数据
类型的建模，指导了对象内存布局及其他一些数据结构和代码的生成。只有理解了语言特性的实现
原理，才真正是磨刀不误砍柴工。

第三部分从服务器端程序开发的角度，梳理了如何从最初的多进程、多线程，逐渐发展到现在的协
程。runtime的调度逻辑还是比较复杂的，但是最核心的思想就是IO多路复用与协程的结合，让每
个任务有自己独立的栈，而同步的核心就是确立Happens Before条件。

第四部分从堆和栈两方面，梳理了内存管理的实现。内存分配方面应重点关注主要的数据结构。至
于GC方面，应先理解宏观层面的整体思想和流程，然后去研究一些细节会更加容易。整个runtime
实际上是个不可分割的整体，在这里会看到内存管理对类型系统的依赖。

致谢
感谢那些喜爱Go语言的网友对笔者的支持；感谢清华大学出版社的赵佳霓编辑；感谢我的家人，
尤其是和我一起讨论技术问题并帮忙整理书稿的妻子，给予我莫大的支持。

由于时间仓促，并且受限于笔者水平，书中难免有不妥之处，请读者见谅，并提宝贵意见。

封幼林
2022 年 5 月
